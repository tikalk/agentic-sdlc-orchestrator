apiVersion: v1
kind: Pod
metadata:
  name: agent-{task-id}
  labels:
    app: agent-orchestrator
    task-id: {task-id}
spec:
  restartPolicy: Never
  volumes:
    - name: ssh-key
      secret:
        secretName: {ssh-secret-name}
  containers:
    - name: agent
      image: agentic-sdlc/opencode:latest
      volumeMounts:
        - name: ssh-key
          mountPath: /root/.ssh
          readOnly: true
      env:
        - name: OPENCODE_SERVER_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: agent-orchestrator-config
              key: server-password
        - name: GIT_REPO
          value: "{repo-url}"
        - name: GIT_BRANCH
          value: "{branch-name}"
        - name: TASK_CONTEXT_PATH
          value: "{context-dir}"
      command: ["/bin/bash", "-c"]
      args:
        - |
          set -e
          cd /workspace
          git clone -b {branch-name} {repo-url} .
          ls -la
          opencode run "Implement the task described in $(ls *.md | head -1)"
          git add .
          git commit -m "feat: completed {task-id}" || true
          git push
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
        requests:
          cpu: "1"
          memory: "2Gi"
  serviceAccountName: agent-orchestrator
