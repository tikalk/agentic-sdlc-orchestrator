{{/*
This is a pod template that can be used as a Job or CronJob template.
It's not deployed directly but referenced by the spawn-pod script.
*/}}
{{- define "agentic-sdlc-orchestrator.podTemplate" -}}
restartPolicy: Never
{{- if .Values.pod.imagePullSecrets }}
imagePullSecrets:
  {{- toYaml .Values.pod.imagePullSecrets | nindent 2 }}
{{- else if .Values.global.imagePullSecrets }}
imagePullSecrets:
  {{- toYaml .Values.global.imagePullSecrets | nindent 2 }}
{{- end }}
serviceAccountName: {{ include "agentic-sdlc-orchestrator.serviceAccountName" . }}
securityContext:
  {{- toYaml .Values.pod.securityContext | nindent 2 }}
{{- if or .Values.pod.sshSecret.enabled .Values.pod.extraVolumes }}
volumes:
  {{- if .Values.pod.sshSecret.enabled }}
  - name: ssh-key
    secret:
      secretName: {{ .Values.pod.sshSecret.name }}
      defaultMode: 0400
  {{- end }}
  {{- with .Values.pod.extraVolumes }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
{{- end }}
containers:
  - name: agent
    image: "{{ .Values.pod.image.repository }}:{{ include "agentic-sdlc-orchestrator.imageTag" . }}"
    imagePullPolicy: {{ .Values.pod.image.pullPolicy }}
    securityContext:
      {{- toYaml .Values.pod.containerSecurityContext | nindent 6 }}
    {{- if or .Values.pod.sshSecret.enabled .Values.pod.extraVolumeMounts }}
    volumeMounts:
      {{- if .Values.pod.sshSecret.enabled }}
      - name: ssh-key
        mountPath: {{ .Values.pod.sshSecret.mountPath }}
        readOnly: true
      {{- end }}
      {{- with .Values.pod.extraVolumeMounts }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
    {{- end }}
    env:
      - name: OPENCODE_SERVER_PASSWORD
        valueFrom:
          secretKeyRef:
            name: {{ include "agentic-sdlc-orchestrator.externalSecretName" . }}
            key: server-password
      - name: GIT_REPO
        value: "{{ .Values.task.defaultRepo }}"
      - name: GIT_BRANCH
        value: "{{ .Values.task.defaultBranch }}"
      - name: TASK_CONTEXT_PATH
        value: "{{ .Values.task.defaultContextDir }}"
      {{- with .Values.pod.env }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
    resources:
      {{- toYaml .Values.pod.resources | nindent 6 }}
{{- with .Values.pod.nodeSelector }}
nodeSelector:
  {{- toYaml . | nindent 2 }}
{{- end }}
{{- with .Values.pod.tolerations }}
tolerations:
  {{- toYaml . | nindent 2 }}
{{- end }}
{{- with .Values.pod.affinity }}
affinity:
  {{- toYaml . | nindent 2 }}
{{- end }}
{{- end }}
